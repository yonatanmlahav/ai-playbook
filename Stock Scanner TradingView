# stock_scanner/tradingview.py
from fastapi import Request, HTTPException
from typing import Dict
import json
from datetime import datetime

class TradingViewWebhook:
    """
    ◊û◊ß◊ë◊ú webhooks ◊û-TradingView ◊ï◊û◊¢◊ë◊ì ◊ê◊ï◊™◊ù
    """
    
    @staticmethod
    async def parse_alert(request: Request) -> Dict:
        """
        ◊û◊†◊™◊ó ◊ê◊™ ◊î-webhook ◊û-TradingView
        """
        try:
            # TradingView ◊©◊ï◊ú◊ó JSON
            body = await request.json()
            
            # ◊§◊ï◊®◊û◊ò ◊ò◊ô◊§◊ï◊°◊ô ◊©◊ú TradingView webhook:
            # {
            #   "ticker": "AAPL",
            #   "price": 150.25,
            #   "volume": 50000000,
            #   "indicator_value": 65.5,
            #   "timestamp": "2024-01-15T10:30:00Z"
            # }
            
            return {
                "symbol": body.get("ticker", body.get("symbol")),
                "price": float(body.get("price", 0)),
                "volume": int(body.get("volume", 0)),
                "timestamp": body.get("timestamp"),
                "raw_data": body
            }
        
        except json.JSONDecodeError:
            # ◊ê◊ù TradingView ◊©◊ú◊ó ◊ò◊ß◊°◊ò ◊®◊í◊ô◊ú
            text = await request.body()
            return {"raw_text": text.decode()}
        
        except Exception as e:
            raise HTTPException(status_code=400, detail=f"Invalid webhook: {str(e)}")
    
    @staticmethod
    def format_signal(prediction: float, symbol: str, price: float) -> str:
        """
        ◊û◊û◊ô◊® ◊™◊ó◊ñ◊ô◊™ ◊ú◊§◊ï◊®◊û◊ò ◊ë◊®◊ï◊®
        """
        if prediction >= 0.7:
            signal = "üöÄ STRONG BUY"
            emoji = "üí∞"
        elif prediction >= 0.55:
            signal = "‚úÖ BUY"
            emoji = "üìà"
        elif prediction >= 0.45:
            signal = "‚ö†Ô∏è NEUTRAL"
            emoji = "‚è∏Ô∏è"
        else:
            signal = "‚ùå AVOID"
            emoji = "üìâ"
        
        return f"{emoji} {symbol} @ ${price:.2f} | Signal: {signal} | Confidence: {prediction*100:.1f}%"
